{% extends 'shop/layouts/main.html' %}

{% block content %}
<section class="bg-light py-4 my-5">
  <div class="container">
    <div class="row">
      <div class="col-12">

        <h4 class="mb-3">{{ product }} Details</h4>
        <hr style="border: none; border-top: 2px solid #b8bfc2;">

        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'collections' %}">Collections</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ product }}</li>
          </ol>
        </nav>

        <div class="card p-3 shadow">
          <div class="row">
            <div class="col-md-6">
              <img src="{{ product.product_image.url }}" alt="{{ product.name }}" class="img-fluid">
            </div>
            <div class="col-md-6">
              <h5>{{ product.name }}</h5>
              <p>{{ product.description }}</p>
              <h6 class="text-success">₹{{ product.selling_price }}</h6>
              <h6 class="text-muted"><del>₹{{ product.original_price }}</del></h6>

              <!-- hidden product id -->
              <input type="hidden" id="pid" value="{{ product.id }}">

              {% if product.quantity > 0 %}
                <button class="btn btn-primary" id="btnCart"><i class="fa fa-cart"></i> Add to Cart</button>
              {% else %}
                <button class="btn btn-danger" disabled>Out of Stock</button>
              {% endif %}

              <!-- fav button with id -->
              <button class="btn btn-outline-danger" id="btnFav"><i class="fa fa-heart"></i></button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("JS loaded ✅");

    const pid     = document.getElementById("pid").value;
    const btnCart = document.getElementById("btnCart");
    const btnFav  = document.getElementById("btnFav");

    // ✅ fav button click
    if (btnFav) {
      btnFav.addEventListener("click", function () {
        let postObj = { 'pid': pid };

        fetch("{% url 'fav' %}", {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": "{{ csrf_token }}"
          },
          body: JSON.stringify(postObj)
        })
        .then(response => response.json())
        .then(data => {
          alert(data['status']);   // ✅ show response
        })
        .catch(error => console.error("Error:", error));
      });
    }

    // ✅ cart button click
    if (btnCart) {
      btnCart.addEventListener("click", function () {
        let postObj = { 'product_qty': 1, 'pid': pid };

        fetch("{% url 'addtocart' %}", {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": "{{ csrf_token }}"
          },
          body: JSON.stringify(postObj)
        })
        .then(response => response.json())
        .then(data => {
          alert(data['status']);
        })
        .catch(error => console.error("Error:", error));
      });
    }
  });
</script>
{% endblock %}
